<!DOCTYPE html>
<html>
<head>
    <title>Nearest Washroom Finder</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <style>
        #map { height: 600px; width: 100%; margin-top: 20px; }
        body { font-family: Arial, sans-serif; margin: 20px; }
    </style>
</head>
<body>
    <h1>Find Nearest Washroom</h1>

    <form method="get" action="/">
        <label for="lat">Latitude:</label>
        <input type="text" name="lat" id="lat" required>
        <label for="lon">Longitude:</label>
        <input type="text" name="lon" id="lon" required>
        <button type="submit">Search</button>
        <button type="button" onclick="useMyLocation()">Use My Location</button>
    </form>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script>
        const map = L.map('map').setView([51.05, -114.07], 11);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        const structures = {{ data | tojson }};
        const userCoords = {{ user_coords | tojson }};
        const nearest = {{ nearest | tojson }};

        structures.forEach(structure => {
            const lat = parseFloat(structure.centroid_lat);
            const lon = parseFloat(structure.centroid_lon);
            const isNearest = nearest && structure.GLOBALID === nearest.GLOBALID;

            if (!isNaN(lat) && !isNaN(lon)) {
                const marker = L.marker([lat, lon], {
                    icon: isNearest ? L.icon({
                        iconUrl: "https://maps.google.com/mapfiles/ms/icons/red-dot.png",
                        iconSize: [32, 32],
                        iconAnchor: [16, 32],
                        popupAnchor: [0, -32]
                    }) : undefined
                }).addTo(map);

                marker.bindPopup(`
                    <strong>${structure.COMMON_NAME}</strong><br>
                    ${structure.BLD_ADDRESS || "No Address"}
                    ${isNearest ? `<br><b>🚻 Closest to you (${parseFloat(nearest.distance_km).toFixed(2)} km)</b>` : ""}
                `);
            }
        });

        if (userCoords[0] && userCoords[1]) {
            const userLat = parseFloat(userCoords[0]);
            const userLon = parseFloat(userCoords[1]);

            if (!isNaN(userLat) && !isNaN(userLon)) {
                L.marker([userLat, userLon], { title: "Your Location" })
                    .addTo(map)
                    .bindPopup("📍 You are here")
                    .openPopup();

                map.setView([userLat, userLon], 13);
            }
        }

        function useMyLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude.toFixed(6);
                    const lon = position.coords.longitude.toFixed(6);
                    window.location.href = `/?lat=${lat}&lon=${lon}`;
                }, () => {
                    alert("Location access denied.");
                });
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }
    </script>
</body>
</html>
